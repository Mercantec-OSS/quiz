@page "/CategoryList"

@inject NavigationManager NavigationManager
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage

<PageTitle>Category list</PageTitle>

<h3>CategoryList</h3>

<ListGroup Mode="ListGroupMode.Selectable">
    @foreach (var (category, i) in categories.Select((category, index) => (category, index)))
    {
        <ListGroupItem Name="@category.Category"
        Clicked="() => categoryShowingUnderCategories != category ?
                GetSubCategories(category) : ClearSubCategories()">
            <Div Flex="Flex.JustifyContent.Between" Width="Width.Is100">
                @category.Category
            </Div>
            @if (categoryShowingUnderCategories == category)
            {
                if (underCategories == null)
                {
                    <Small>
                        Loading...
                    </Small>
                }
                else
                {
                    if (underCategories.Count > 0)
                    {
                        foreach (UnderCategoriesGetDTO item in underCategories)
                        {
                            <Div>
                                <Small>@item.UnderCategory</Small>
                            </Div>
                        }
                    }
                    else
                    {
                        <Small>No Under Category found.</Small>
                    }
                }
            }
        </ListGroupItem>
    }
</ListGroup>

@if (isLoading)
{
    <div class="spinner-container">
        <div class="spinner"></div>
    </div>
}

@code {
    [Inject] public HttpClient? Http { get; set; }
    private List<CategoriesDTO> categories = new();
    private CategoriesDTO? categoryShowingUnderCategories;
    private List<UnderCategoriesGetDTO>? underCategories;

    private bool isLoading = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (Http == null) return;
            isLoading = true;
            StateHasChanged();

            string jwt = await sessionStorage.GetItemAsync<string>("jwt");
            if (string.IsNullOrEmpty(jwt))
            {
                NavigationManager.NavigateTo("/");
                return;
            }

            string userRole = await sessionStorage.GetItemAsync<string>("userRole");
            if (string.IsNullOrEmpty(userRole) || userRole == "Student")
            {
                NavigationManager.NavigateTo("/home");
                return;
            }

            (HttpStatusCode statusCode, List<CategoriesDTO>? response) =
                await HttpHandler.GetAsync<List<CategoriesDTO>>("api/Categories", jwt, Http);

            if (statusCode == HttpStatusCode.OK)
            {
                categories = response ?? new();
            }

            isLoading = false;
            StateHasChanged();
        }
    }

    private Task ClearSubCategories()
    {
        underCategories = null;
        categoryShowingUnderCategories = null;
        return Task.CompletedTask;
    }

    private async Task GetSubCategories(CategoriesDTO category)
    {
        await ClearSubCategories();
        categoryShowingUnderCategories = category;

        string jwt = await sessionStorage.GetItemAsync<string>("jwt");
        if (Http == null) return;

        (HttpStatusCode statusCode, List<UnderCategoriesGetDTO>? response) =
            await HttpHandler.GetAsync<List<UnderCategoriesGetDTO>>(
                $"api/UnderCategories/CategoryID/{category.ID}", jwt, Http);

        if (statusCode == HttpStatusCode.OK)
        {
            underCategories = response ?? new();
        }
    }
}
