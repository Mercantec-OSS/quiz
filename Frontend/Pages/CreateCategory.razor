@page "/createCategory"
@inject NavigationManager NavigationManager
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage

<PageTitle>Create Kategori</PageTitle>

<Div style="display: flex; align-items: center; flex-direction: column;">
    <h1>Create Kategori</h1>

    <Div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
        <Dropdown Display="Display.InlineBlock">
            <DropdownToggle Color="Color.Primary">
                @(selectedCategory == null ? "Vælg Kategori" : selectedCategory.Category)
            </DropdownToggle>
            <DropdownMenu MaxMenuHeight="100px">
                <DropdownItem>
                    <input type="text" class="form-control" placeholder="Search"
                    @oninput="SearchWordChange"
                    @bind="searchWord" />
                </DropdownItem>
                <DropdownDivider />
                @foreach (CategoriesDTO category in searchWord == string.Empty ?
                categories : categories.Where(c =>
                c.Category.ToLower().Contains(searchWord.ToLower())))
                {
                    @if (category != selectedCategory)
                    {
                        <DropdownItem Clicked="() => SelectCategory(category)">
                            @category.Category
                        </DropdownItem>
                    }
                }
            </DropdownMenu>
        </Dropdown>

        <Button Class="btn btn-warning" Disabled="@(selectedCategory == null)"
        Clicked="() => ToggleEditCategoryModal(selectedCategory)">
            Edit Kategori
        </Button>

        <Button Class="btn btn-success" Clicked="OpenModalAddNewCategory">
            Add Kategori
        </Button>
    </Div>
</Div>

<Table Striped Resizable ResizeMode="TableResizeMode.Columns">
    <TableHeader>
        <TableRow>
            <TableHeaderCell>Under Category</TableHeaderCell>
            <TableHeaderCell>Edit</TableHeaderCell>
            <TableHeaderCell>Delete</TableHeaderCell>
        </TableRow>
    </TableHeader>
    <TableBody>
        @foreach (UnderCategoriesGetDTO underCategory in underCategories)
        {
            <TableRow>
                <TableRowCell>@underCategory.UnderCategory</TableRowCell>
                <TableRowCell>
                    <button class="btn btn-warning"
                    @onclick="() => ToggleEditUnderCategoryModal(underCategory)">
                        Edit
                    </button>
                </TableRowCell>
                <TableRowCell>
                    <button class="btn btn-danger"
                    @onclick="() => ToggleDeleteConfirmation(underCategory)">
                        Delete
                    </button>
                </TableRowCell>
            </TableRow>
        }
        @if (selectedCategory != null)
        {
            <TableRow>
                <TableRowCell>
                    <button class="btn btn-primary" @onclick="OpenModalAddNewUnderCategory">
                        Add New Under Category
                    </button>
                </TableRowCell>
                <TableRowCell></TableRowCell>
                <TableRowCell></TableRowCell>
            </TableRow>
        }
    </TableBody>
</Table>

<Modal @ref="modalAddNewCategory">
    <ModalContent Centered>
        <ModalHeader>
            <ModalTitle>Add new category</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            <Field>
                <TextEdit @bind-Text="newCategory" Placeholder="Enter category..." />
            </Field>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="() => CloseModal(modalAddNewCategory)">Close</Button>
            <Button Color="Color.Primary" Clicked="AddNewCategory">Save</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<Modal @ref="modalAddNewUnderCategory">
    <ModalContent Centered>
        <ModalHeader>
            <ModalTitle>Add new under category</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            <Field>
                <TextEdit @bind-Text="newUnderCategory" Placeholder="Enter under category..." />
            </Field>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="() => CloseModal(modalAddNewUnderCategory)">Close</Button>
            <Button Color="Color.Primary" Clicked="AddNewUnderCategory">Save</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<Modal @ref="modalEditCategory">
    <ModalContent Centered>
        <ModalHeader>
            <ModalTitle>Edit category</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            <Field>
                <TextEdit @bind-Text="editCategoryText" Placeholder="Enter category..." />
            </Field>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="() => CloseModal(modalEditCategory)">Close</Button>
            <Button Color="Color.Primary" Clicked="SaveEditedCategory">Save</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<Modal @ref="modalEditUnderCategory">
    <ModalContent Centered>
        <ModalHeader>
            <ModalTitle>Edit under category</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            <Field>
                <TextEdit @bind-Text="editUnderCategoryText" Placeholder="Enter under category..." />
            </Field>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="() => CloseModal(modalEditUnderCategory)">Close</Button>
            <Button Color="Color.Primary" Clicked="SaveEditedUnderCategory">Save</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<Modal @ref="modalDeleteConfirmation">
    <ModalContent Centered>
        <ModalHeader>
            <ModalTitle>Are you sure you want to  delete this under kategori?</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            You can't undo this action.
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="() => CloseModal(modalDeleteConfirmation)">Cancel</Button>
            <Button Color="Color.Primary" Clicked="DeleteConfirmed">Delete</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<Modal @ref="modalErrorHappened">
    <ModalContent Centered>
        <ModalHeader>
            <ModalTitle>An error happened</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="() => CloseModal(modalErrorHappened)">Ok</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<LoadingSpinner @ref="loading" />

@code {
    [Inject] public HttpClient? Http { get; set; }
    private JWTokenHandler? jWTokenHandler;

    private CategoryDTO? selectedCategory = null;
    private List<CategoryDTO> categories = new();

    private List<UnderCategoryGetDTO> underCategories = new();

    private string newCategory = string.Empty;
    private string newUnderCategory = string.Empty;

    private string editCategoryText = string.Empty;
    private CategoryDTO? editCategory = null;

    private string editUnderCategoryText = string.Empty;
    private UnderCategoryGetDTO? editUnderCategory = null;

    private UnderCategoryGetDTO? underCategoryToBeDeleted = null;

    private string searchWord = string.Empty;
    private LoadingSpinner? loading;
    private Modal? modalErrorHappened;

    private Modal? modalAddNewCategory;
    private Modal? modalAddNewUnderCategory;
    private Modal? modalEditCategory;
    private Modal? modalEditUnderCategory;
    private Modal? modalDeleteConfirmation;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (Http == null) return;
            if (jWTokenHandler == null) return;

            string jwt = await jWTokenHandler.GetToken();

            loading?.Start();

            (HttpStatusCode statusCode, List<CategoryDTO>? response) =
                await HttpHandler.GetAsync<List<CategoryDTO>>("api/Categories", jwt, Http);

            if (statusCode == HttpStatusCode.OK)
            {
                categories = response ?? new();
            }
            else
            {
                modalErrorHappened?.Show();
            }

            loading?.Stop();
        }
    }

    private void SearchWordChange(ChangeEventArgs e)
    {
        searchWord = e.Value?.ToString() ?? string.Empty;
    }

    private void CloseModal(Modal? modal) => modal?.Hide();

    private void OpenModalAddNewCategory()
    {
        newCategory = string.Empty;
        modalAddNewCategory?.Show();
    }

    private void OpenModalAddNewUnderCategory()
    {
        newUnderCategory = string.Empty;
        modalAddNewUnderCategory?.Show();
    }

    private void ToggleDeleteConfirmation(UnderCategoryGetDTO? underCategory = null)
    {
        underCategoryToBeDeleted = underCategory;
        if (underCategoryToBeDeleted == null)
        {
            modalDeleteConfirmation?.Hide();
            return;
        }
        modalDeleteConfirmation?.Show();
    }

    private void ToggleEditCategoryModal(CategoryDTO? category = null)
    {
        editCategory = category;
        editCategoryText = editCategory != null
            ? editCategory.Category : string.Empty;

        if (editCategory == null)
        {
            modalEditCategory?.Hide();
            return;
        }
        modalEditCategory?.Show();
    }

    private void ToggleEditUnderCategoryModal(UnderCategoryGetDTO? underCategory = null)
    {
        editUnderCategory = underCategory;
        editUnderCategoryText = editUnderCategory != null
            ? editUnderCategory.UnderCategory : string.Empty;

        if (editUnderCategory == null)
        {
            modalEditUnderCategory?.Hide();
            return;
        }
        modalEditUnderCategory?.Show();
    }

    private async Task SelectCategory(CategoryDTO category)
    {
        selectedCategory = category;

        if (Http == null) return;
        loading?.Start();
        string jwt = await sessionStorage.GetItemAsync<string>("jwt");

        (HttpStatusCode statusCode, List<UnderCategoryGetDTO>? response) =
                await HttpHandler.GetAsync<List<UnderCategoryGetDTO>>(
                    $"api/UnderCategories/CategoryID/{category.ID}", jwt, Http);

        if (statusCode == HttpStatusCode.OK)
        {
            underCategories = response ?? new();
        }
        else
        {
            modalErrorHappened?.Show();
        }

        loading?.Stop();
    }

    private async Task SaveEditedCategory()
    {
        if (Http == null || this.editCategory == null)
        {
            ToggleEditCategoryModal();
            return;
        }

        loading?.Start();
        string jwt = await sessionStorage.GetItemAsync<string>("jwt");

        CategoriesDTO editCategory = new()
            {
                ID = this.editCategory.ID,
                Category = editCategoryText,
                Education = this.editCategory.Education
            };

        (HttpStatusCode statusCode, CategoriesDTO? response) =
           await HttpHandler.PutAsync<CategoriesDTO>(
               $"/api/Categories/{editCategory.ID}", editCategory, jwt, Http);

        if (statusCode == HttpStatusCode.OK)
        {
            this.editCategory.Category = editCategoryText;
        }
        else
        {
            modalErrorHappened?.Show();
        }

        ToggleEditCategoryModal();
        loading?.Stop();
    }

    private async Task SaveEditedUnderCategory()
    {
        if (Http == null || this.editUnderCategory == null)
        {
            ToggleEditUnderCategoryModal();
            return;
        }

        loading?.Start();
        string jwt = await sessionStorage.GetItemAsync<string>("jwt");

        UnderCategoriesGetDTO editUnderCategory = new()
            {
                ID = this.editUnderCategory.ID,
                UnderCategory = this.editUnderCategory.UnderCategory,
            };

        HttpStatusCode statusCode =
           await HttpHandler.PutAsync(
               $"/api/UnderCategories/{editUnderCategory.ID}", editUnderCategory, jwt, Http);

        if (statusCode == HttpStatusCode.OK)
        {
            this.editUnderCategory.UnderCategory = editUnderCategory.UnderCategory;
        }
        else
        {
            modalErrorHappened?.Show();
        }

        ToggleEditUnderCategoryModal();
        loading?.Stop();
    }

    private async Task DeleteConfirmed()
    {
        if (Http == null || underCategoryToBeDeleted == null)
            return;

        loading?.Start();
        string jwt = await sessionStorage.GetItemAsync<string>("jwt");
        HttpStatusCode statusCode = await HttpHandler.DeleteAsync(
                    $"/api/UnderCategories/{underCategoryToBeDeleted.ID}", jwt, Http);

        if (statusCode == HttpStatusCode.NoContent)
        {
            underCategories.Remove(underCategoryToBeDeleted);
        }
        else
        {
            modalErrorHappened?.Show();
        }

        ToggleDeleteConfirmation();
        loading?.Stop();
    }

    private async Task AddNewCategory()
    {
        CloseModal(modalAddNewCategory);
        string newCategoryText = this.newCategory;
        this.newCategory = string.Empty;

        if (Http == null) return;
        loading?.Start();
        string jwt = await sessionStorage.GetItemAsync<string>("jwt");

        CategoryCreateDTO newCategory = new()
            {
                Category = newCategoryText,
                EducationID = 1,
            };

        (HttpStatusCode statusCode, CategoryDTO? response) =
           await HttpHandler.PostAsync<CategoryDTO>(
               $"api/Categories", newCategory, jwt, Http);

        if (statusCode == HttpStatusCode.Created && response != null)
        {
            selectedCategory = response;
            categories.Add(response);
            underCategories.Clear();
        }
        else
        {
            modalErrorHappened?.Show();
        }

        loading?.Stop();
    }

    private async Task AddNewUnderCategory()
    {
        CloseModal(modalAddNewUnderCategory);
        string newUnderCategory = this.newUnderCategory;
        this.newUnderCategory = string.Empty;

        if (selectedCategory == null) return;
        if (Http == null) return;
        loading?.Start();
        string jwt = await sessionStorage.GetItemAsync<string>("jwt");

        UnderCategoryCreateDTO newUnderCategories = new()
            {
                UnderCategory = newUnderCategory,
                CategoryID = selectedCategory.ID
            };

        (HttpStatusCode statusCode, UnderCategoriesGetDTO? response) =
                await HttpHandler.PostAsync<UnderCategoriesGetDTO>(
                    $"api/UnderCategories", newUnderCategories, jwt, Http);

        if (statusCode == HttpStatusCode.Created && response != null)
        {
            underCategories.Add(response);
        }
        else
        {
            modalErrorHappened?.Show();
        }

        loading?.Stop();
    }
}
